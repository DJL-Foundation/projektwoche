---
import Layout from "~/layouts/Layout.astro";
import ProjectCard from "~/components/ProjectCard.astro";
import { Badge } from "prowo-ui/ui/badge";
import { getAllProjectsForYear, getWorkshopYear, getAvailableYears, getActiveYear, getPreviewImageUrl } from "~/lib/projects";
import { buttonVariants } from "prowo-ui/ui/button";
import { cn } from "prowo-ui/lib/utils"

const activeYear = getActiveYear();
const availableYears = getAvailableYears();

const workshopYear = getWorkshopYear(activeYear);
const allProjects = getAllProjectsForYear(activeYear);

// Sort projects alphabetically by project name
const sortedProjects = allProjects.sort((a, b) => a.project.name.localeCompare(b.project.name));

const workshopMeta = workshopYear?.['!'];
---

<Layout>
  <div class="container mx-auto px-4 py-8">
    <!-- Year Navigation - Top -->
    <div class="mb-8">
      <!-- Main Header with Year and Meta Info -->
      <div class="text-center mb-6">
      <div class="flex items-center justify-center gap-4 mb-4">
        <h1 class="ledger-regular text-4xl md:text-6xl font-bold">
        {workshopMeta?.displayName || `Projektwoche ${activeYear}`}
        </h1>
        <Badge variant="default">Aktuell</Badge>
      </div>
      <p class="text-xl md:text-2xl text-muted-foreground mb-6">
        Entdecke die kreativen Projekte unserer Schüler aus den verschiedenen Projektwochen
      </p>
      <div class="flex items-center justify-center gap-4 text-sm text-muted-foreground mb-6">
        <span>{allProjects.length} Projekte</span>
        <span>{new Set(allProjects.map(p => p.username)).size} Teilnehmer</span>
      </div>
      </div>
      
      <!-- Year Selection -->
      <div class="flex justify-center mb-8">
      <div class="flex items-center gap-2 p-1 bg-muted rounded-lg">
        <span class="text-sm text-muted-foreground mx-2">Jahr:</span>
        {availableYears.map((year) => (
        <a
          class={cn(buttonVariants({ variant: year === activeYear ? "default" : "ghost", size: "sm" }))}
          href={`/projekte/${year}`}
        >
          {year}
        </a>
        ))}
      </div>
      </div>
    </div>

    {allProjects.length === 0 ? (
      <div class="text-center py-12">
        <h2 class="text-xl font-semibold mb-2">Noch keine Projekte</h2>
        <p class="text-muted-foreground">
          Für das Jahr {activeYear} wurden noch keine Projekte hochgeladen.
        </p>
      </div>
    ) : (
      <>
        {/* All Projects Grid - sorted alphabetically */}
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
          {sortedProjects.map(({ username, displayName, projectName, project }) => (
            <ProjectCard
              username={username}
              displayName={displayName}
              projectName={projectName}
              project={project}
              year={activeYear}
              previewImageUrl={getPreviewImageUrl(activeYear, username, projectName)}
            />
          ))}
        </div>
      </>
    )}

    <!-- Year Navigation - Bottom -->
    <div class="mt-12 pt-8 border-t border-border">
      <div class="flex justify-center">
        <div class="flex items-center gap-2 p-1 bg-muted rounded-lg">
          <span class="text-sm text-muted-foreground mx-2">Andere Jahre:</span>
          {availableYears.filter(year => year !== activeYear).map((year) => (
            <a
              class={cn(buttonVariants({ variant: "ghost", size: "sm" }))}
              href={`/projekte/${year}`}
            >
              {year}
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
</Layout>